"use strict";var j=(e=>(e.email="email",e.profile="profile",e.openid="openid",e.offline_access="offline",e))(j||{}),E=(e=>(e.none="none",e.create="create",e.login="login",e))(E||{}),L=(e=>(e.organizationDetails="organization_details",e.organizationMembers="organization_members",e.organizationPlanDetails="organization_plan_details",e.organizationPaymentDetails="organization_payment_details",e.organizationPlanSelection="organization_plan_selection",e.profile="profile",e))(L||{}),q=(e=>(e.organizationDetails="organization_details",e.organizationMembers="organization_members",e.organizationPlanDetails="organization_plan_details",e.organizationPaymentDetails="organization_payment_details",e.organizationPlanSelection="organization_plan_selection",e.profile="profile",e))(q||{}),C=(e=>(e.logout="logout",e.login="login",e.register="registration",e.token="token",e.profile="profile",e))(C||{}),S=(e=>(e[e.refreshToken=0]="refreshToken",e[e.cookie=1]="cookie",e))(S||{});const b=e=>{const t=c=>btoa(c).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");if(e instanceof ArrayBuffer){const c=new Uint8Array(e),a=String.fromCharCode(...c);return t(a)}const n=new TextEncoder().encode(e),o=String.fromCharCode(...n);return t(o)},P=(e=28)=>{if(crypto){const t=new Uint8Array(e/2);return crypto.getRandomValues(t),Array.from(t,G).join("")}else return Z(e)};function G(e){return e.toString(16).padStart(2,"0")}function Z(e=28){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let r="";const n=t.length;for(let o=0;o<e;o++)r+=t.charAt(Math.floor(Math.random()*n));return r}const Q=e=>{e=e.split("?")[1];const t=new URLSearchParams(e);return{accessToken:t.get("access_token"),idToken:t.get("id_token"),expiresIn:+(t.get("expires_in")||0)}},U=e=>e.replace(/\/$/,""),B=(e,t=!1)=>{const r=Array.isArray(e.audience)?e.audience.join(" "):e.audience||"",n={login_hint:e.loginHint,is_create_org:e.isCreateOrg?.toString(),connection_id:e.connectionId,redirect_uri:e.redirectURL?t?e.redirectURL:U(e.redirectURL):void 0,audience:r,scope:e.scope?.join(" ")||"email profile openid offline",prompt:e.prompt,lang:e.lang,org_code:e.orgCode,org_name:e.orgName,has_success_page:e.hasSuccessPage?.toString(),workflow_deployment_id:e.workflowDeploymentId,supports_reauth:e.supportsReauth?.toString(),plan_interest:e.planInterest,pricing_table_key:e.pricingTableKey};return Object.keys(n).forEach(o=>n[o]===void 0&&delete n[o]),n},z=e=>typeof e!="object"||e===null?e:Array.isArray(e)?e.map(t=>z(t)):Object.fromEntries(Object.entries(e).map(([t,r])=>[t.replace(/_([a-z])/g,(n,o)=>o.toUpperCase()),z(r)])),X=["utm_source","utm_medium","utm_campaign","utm_content","utm_term","gclid","click_id","hsa_acc","hsa_cam","hsa_grp","hsa_ad","hsa_src","hsa_tgt","hsa_kw","hsa_mt","hsa_net","hsa_ver","match_type","keyword","device","ad_group_id","campaign_id","creative","network","ad_position","fbclid","li_fat_id","msclkid","twclid","ttclid"],Y=async(e,t=C.login,r,n)=>{const o=`${e}/oauth2/auth`,c=x();if(r.reauthState)try{const u=z(JSON.parse(atob(r.reauthState)));r={...r,...u},delete r.reauthState}catch(u){const h=u instanceof Error?u.message:"Unknown error";throw new Error(`Error handing reauth state: ${h}`)}if(!r.clientId)throw new Error("Error generating auth URL: Client ID missing");const a={client_id:r.clientId,response_type:r.responseType||"code",...B(r,n?.disableUrlSanitization)};r.state||(r.state=P(32)),c&&c.setSessionItem(i.state,r.state),a.state=r.state,r.nonce||(r.nonce=P(16)),a.nonce=r.nonce,c&&c.setSessionItem(i.nonce,r.nonce);let f="";if(r.codeChallenge)a.code_challenge=r.codeChallenge;else{const{codeVerifier:u,codeChallenge:h}=await O();f=u,c&&c.setSessionItem(i.codeVerifier,u),a.code_challenge=h}a.code_challenge_method="S256",r.codeChallengeMethod&&(a.code_challenge_method=r.codeChallengeMethod),!r.prompt&&t===C.register&&(a.prompt=E.create),r.properties&&Object.keys(r.properties).forEach(u=>{if(!X.includes(u)){console.warn("Unsupported Property for url generation: ",u);return}const h=r.properties?.[u];h!==void 0&&(a[u]=h)});const l=new URLSearchParams(a).toString();return{url:new URL(`${o}?${l}`),state:a.state,nonce:a.nonce,codeChallenge:a.code_challenge,codeVerifier:f}};async function O(){const e=P(52),t=new TextEncoder().encode(e);let r="";if(!crypto)r=b(btoa(e));else{const n=await crypto.subtle.digest("SHA-256",t);r=b(n)}return{codeVerifier:e,codeChallenge:r}}let I;function N(e,t){if(R(),typeof window>"u")throw new Error("setRefreshTimer requires a browser environment");if(e<=0)throw new Error("Timer duration must be positive");I=window.setTimeout(t,Math.min(e*1e3-1e4,864e5))}function R(){I!==void 0&&(window.clearTimeout(I),I=void 0)}const w={framework:"",frameworkVersion:"",sdkVersion:""},V=async()=>{await x()?.removeItems(i.state,i.nonce,i.codeVerifier)},K=async({urlParams:e,domain:t,clientId:r,redirectURL:n,autoRefresh:o=!1,onRefresh:c})=>{const a=e.get("state"),f=e.get("code");if(!a||!f)return console.error("Invalid state or code"),{success:!1,error:"Invalid state or code"};const l=x();if(!l)return console.error("No active storage found"),{success:!1,error:"Authentication storage is not initialized"};(!w.framework||!w.frameworkVersion)&&console.warn("Framework and version not set. Please set the framework and version in the config object");const u=await l.getSessionItem(i.state);if(a!==u)return console.error("Invalid state"),{success:!1,error:`Invalid state; supplied ${a}, expected ${u}`};const h=await l.getSessionItem(i.codeVerifier);if(h===null)return console.error("Code verifier not found"),{success:!1,error:"Code verifier not found"};const F={"Content-type":"application/x-www-form-urlencoded; charset=UTF-8"};w.framework&&(F["Kinde-SDK"]=`${w.framework}/${w.sdkVersion}/${w.frameworkVersion}/Javascript`);const J={method:"POST",...!s.useInsecureForRefreshToken&&v(t)?{credentials:"include"}:{},headers:new Headers(F),body:new URLSearchParams({client_id:r,code:f,code_verifier:h,grant_type:"authorization_code",redirect_uri:n})};let _;R();try{if(_=await fetch(`${t}/oauth2/token`,J),!_?.ok){const k=await _.text();return console.error("Token exchange failed:",_.status,k),{success:!1,error:`Token exchange failed: ${_.status} - ${k}`}}}catch(k){return V(),console.error("Token exchange failed:",k),{success:!1,error:`Token exchange failed: ${k}`}}const d=await _.json(),M=p();M&&M.setItems({[i.accessToken]:d.access_token,[i.idToken]:d.id_token,[i.refreshToken]:d.refresh_token}),(s.useInsecureForRefreshToken||!v(t))&&l.setSessionItem(i.refreshToken,d.refresh_token),o&&N(d.expires_in,async()=>{T({domain:t,clientId:r,onRefresh:c})}),V();const W=(k=>(k.search="",k))(new URL(window.location.toString()));return window.history.replaceState(window.history.state,"",W),!d.access_token||!d.id_token||!d.refresh_token?{success:!1,error:"No access token received"}:{success:!0,[i.accessToken]:d.access_token,[i.idToken]:d.id_token,[i.refreshToken]:d.refresh_token}};function ee(e){const r=document.cookie.split("; ").find(n=>n.startsWith(`${e}=`));if(!r)return null;try{const n=r.split("=")[1];return n?decodeURIComponent(n):null}catch(n){return console.error(`Error parsing cookie ${e}:`,n),null}}const re="_kbrte",te=async({domain:e,clientId:t})=>{if(!e)return{success:!1,error:"Domain is required for authentication check"};if(!t)return{success:!1,error:"Client ID is required for authentication check"};const r=v(e),n=s.useInsecureForRefreshToken;let o=null;return r&&!n&&(o=ee(re)),await T({domain:e,clientId:t,refreshType:o?S.cookie:S.refreshToken})},v=e=>!e.match(/^(?:https?:\/\/)?[a-zA-Z0-9][.-a-zA-Z0-9]*\.kinde\.com$/i);function y(e,t){return t<=0?[]:e.match(new RegExp(`.{1,${t}}`,"g"))||[]}var i=(e=>(e.accessToken="accessToken",e.idToken="idToken",e.refreshToken="refreshToken",e.state="state",e.nonce="nonce",e.codeVerifier="codeVerifier",e))(i||{});class ${async setItems(t){await Promise.all(Object.entries(t).map(([r,n])=>this.setSessionItem(r,n)))}async removeItems(...t){await Promise.all(t.map(r=>this.removeSessionItem(r)))}}class ne extends ${memCache={};async destroySession(){this.memCache={}}async setSessionItem(t,r){if(await this.removeSessionItem(t),typeof r=="string"){y(r,s.maxLength).forEach((n,o)=>{this.memCache[`${s.keyPrefix}${t}${o}`]=n});return}this.memCache[`${s.keyPrefix}${String(t)}0`]=r}async getSessionItem(t){if(this.memCache[`${s.keyPrefix}${String(t)}0`]===void 0)return null;let r="",n=0,o=`${s.keyPrefix}${String(t)}${n}`;for(;this.memCache[o]!==void 0;)r+=this.memCache[o],n++,o=`${s.keyPrefix}${String(t)}${n}`;return r}async removeSessionItem(t){for(const r in this.memCache)r.startsWith(`${s.keyPrefix}${String(t)}`)&&delete this.memCache[r]}}function A(e){return new Promise((t,r)=>{chrome.storage.local.get([e],function(n){chrome.runtime.lastError?r(void 0):t(n[e])})})}class oe extends ${async destroySession(){await chrome.storage.local.clear()}async setSessionItem(t,r){if(await this.removeSessionItem(t),typeof r=="string"){y(r,s.maxLength).forEach(async(n,o)=>{await chrome.storage.local.set({[`${s.keyPrefix}${t}${o}`]:n})});return}await chrome.storage.local.set({[`${s.keyPrefix}${t}0`]:r})}async getSessionItem(t){let r="",n=0,o=`${s.keyPrefix}${String(t)}${n}`;for(;await A(`${s.keyPrefix}${String(t)}${n}`)!==void 0;)r+=await A(o),n++,o=`${s.keyPrefix}${String(t)}${n}`;return r}async removeSessionItem(t){let r=0;for(;await A(`${s.keyPrefix}${String(t)}${r}`)!==void 0;)await chrome.storage.local.remove(`${s.keyPrefix}${String(t)}${r}`),r++}}class se extends ${constructor(){super(),s.useInsecureForRefreshToken&&console.warn("LocalStorage store should not be used in production")}internalItems=new Set;async destroySession(){this.internalItems.forEach(t=>{this.removeSessionItem(t)})}async setSessionItem(t,r){if(await this.removeSessionItem(t),this.internalItems.add(t),typeof r=="string"){y(r,s.maxLength).forEach((n,o)=>{localStorage.setItem(`${s.keyPrefix}${t}${o}`,n)});return}localStorage.setItem(`${s.keyPrefix}${t}0`,r)}async getSessionItem(t){if(localStorage.getItem(`${s.keyPrefix}${t}0`)===null)return null;let r="",n=0,o=`${s.keyPrefix}${String(t)}${n}`;for(;localStorage.getItem(o)!==null;)r+=localStorage.getItem(o),n++,o=`${s.keyPrefix}${String(t)}${n}`;return r}async removeSessionItem(t){let r=0;for(;localStorage.getItem(`${s.keyPrefix}${String(t)}${r}`)!==null;)localStorage.removeItem(`${s.keyPrefix}${String(t)}${r}`),r++;this.internalItems.delete(t)}}class ae extends ${kvNamespace;defaultTtl;constructor(t,r){super(),this.kvNamespace=t,this.defaultTtl=r?.defaultTtl||3600,s.useInsecureForRefreshToken&&console.warn("KvStorage: useInsecureForRefreshToken is enabled - consider security implications for refresh tokens in KV storage")}async destroySession(){try{const{keys:t}=await this.kvNamespace.list({prefix:s.keyPrefix});await Promise.all(t.map(r=>this.kvNamespace.delete(r.name)))}catch(t){throw console.error("KvStorage: Failed to destroy session:",t),t}}async setSessionItem(t,r){try{if(await this.removeSessionItem(t),typeof r=="string"){const o=y(r,s.maxLength);await Promise.all(o.map((c,a)=>this.kvNamespace.put(`${s.keyPrefix}${t}${a}`,c,{expirationTtl:this.defaultTtl})));return}const n=typeof r=="object"?JSON.stringify(r):String(r);await this.kvNamespace.put(`${s.keyPrefix}${String(t)}0`,n,{expirationTtl:this.defaultTtl})}catch(n){throw console.error(`KvStorage: Failed to set session item ${String(t)}:`,n),n}}async getSessionItem(t){try{const r=await this.kvNamespace.get(`${s.keyPrefix}${String(t)}0`);if(r===null)return null;let n="",o=0,c=r;for(;c!==null;)n+=c,o++,c=await this.kvNamespace.get(`${s.keyPrefix}${String(t)}${o}`);return n}catch(r){return console.error(`KvStorage: Failed to get session item ${String(t)}:`,r),null}}async removeSessionItem(t){try{const r=[];let n=0;for(;;){const o=`${s.keyPrefix}${String(t)}${n}`;if(await this.kvNamespace.get(o)===null)break;r.push(o),n++}await Promise.all(r.map(o=>this.kvNamespace.delete(o)))}catch(r){throw console.error(`KvStorage: Failed to remove session item ${String(t)}:`,r),r}}setDefaultTtl(t){this.defaultTtl=t}getDefaultTtl(){return this.defaultTtl}}const s={keyPrefix:"kinde-",maxLength:2e3,useInsecureForRefreshToken:!1};function ie(e,t){if(!e)return null;const r=e.split(".");if(r.length!==3)return null;const n=r[1].replace(/-/g,"+").replace(/_/g,"/"),o=decodeURIComponent(atob(n).split("").map(c=>"%"+("00"+c.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(o)}const m=async(e=i.accessToken)=>{const t=p();if(!t)return null;const r=await t.getSessionItem(e==="accessToken"?i.accessToken:i.idToken);if(!r)return null;const n=ie(r);return n||console.warn("No decoded token found"),n},D=async(e="accessToken")=>m(e),ce=async(e,t="accessToken")=>{const r=await D(t);return r?{name:e,value:r[e]}:null},le=async()=>{const e=await m();return e?e.org_code||e["x-hasura-org-code"]:null},ue=async(e=i.accessToken)=>{const t=p();if(!t)return null;const r=await t.getSessionItem(e==="accessToken"?i.accessToken:i.idToken);return r||null},fe=async e=>{const t=await m();if(!t)return null;const r=t.feature_flags||t["x-hasura-feature-flags"];return r?r[e]?.v??null:null},de=async()=>{const e=await D("idToken");if(!e)return null;const{sub:t}=e;return t?{id:e.sub,givenName:e.given_name,familyName:e.family_name,email:e.email,picture:e.picture}:(console.error("No sub in idToken"),null)},he=async e=>{const t=await m();if(!t)return{permissionKey:e,orgCode:null,isGranted:!1};const r=t.permissions||[];return{permissionKey:e,orgCode:t.org_code,isGranted:!!r.includes(e)}},ge=async()=>{const e=await m();if(!e)return{orgCode:null,permissions:[]};const t=e.permissions||e["x-hasura-permissions"]||[];return{orgCode:e.org_code||e["x-hasura-org-code"],permissions:t}},me=async()=>{const e=await m("idToken");return e?!e.org_codes&&!e["x-hasura-org-codes"]?(console.warn("Org codes not found in token, ensure org codes have been included in the token customisation within the application settings"),null):e.org_codes||e["x-hasura-org-codes"]:null},ke=async()=>{const e=await m();return e?!e.roles&&!e["x-hasura-roles"]?(console.warn("No roles found in token, ensure roles have been included in the token customisation within the application settings"),[]):e.roles||e["x-hasura-roles"]:[]},Se=async e=>{try{const t=await m("accessToken");if(!t)return!1;if(!t.exp)return console.error("Token does not have an expiry"),!1;const r=t.exp<Math.floor(Date.now()/1e3);return r&&e?.useRefreshToken?(await T({domain:e.domain,clientId:e.clientId})).success:!r}catch(t){return console.error("Error checking authentication:",t),!1}},T=async({domain:e,clientId:t,refreshType:r=S.refreshToken,onRefresh:n})=>{const o=f=>(n&&n(f),f);if(!e)return o({success:!1,error:"Domain is required for token refresh"});if(!t)return o({success:!1,error:"Client ID is required for token refresh"});let c="",a;if(s.useInsecureForRefreshToken||!v(e)?a=x():a=p(),r===S.refreshToken){if(!a)return o({success:!1,error:"No active storage found"});if(c=await a.getSessionItem(i.refreshToken),!c)return o({success:!1,error:"No refresh token found"})}R();try{const f=await fetch(`${U(e)}/oauth2/token`,{method:"POST",...r===S.cookie&&{credentials:"include"},headers:{"Content-type":"application/x-www-form-urlencoded; charset=UTF-8"},body:new URLSearchParams({...r===S.refreshToken&&{refresh_token:c},grant_type:"refresh_token",client_id:t}).toString()});if(!f.ok)return o({success:!1,error:"Failed to refresh token"});const l=await f.json();if(l.access_token){const u=p();return u?(N(l.expires_in,async()=>{T({domain:e,clientId:t,refreshType:r,onRefresh:n})}),a&&(await u.setSessionItem(i.accessToken,l.access_token),l.id_token&&await u.setSessionItem(i.idToken,l.id_token),l.refresh_token&&await a.setSessionItem(i.refreshToken,l.refresh_token)),o({success:!0,[i.accessToken]:l.access_token,[i.idToken]:l.id_token,[i.refreshToken]:l.refresh_token})):o({success:!1,error:"No active storage found"})}}catch(f){return o({success:!1,error:`No access token received: ${f}`})}return o({success:!1,error:"No access token received"})},g={secure:null,insecure:null},we=e=>{g.secure=e},p=()=>g.secure||null,pe=()=>g.secure!==null,_e=()=>{g.secure=null},ve=e=>{g.insecure=e},x=()=>g.insecure||g.secure||null,ye=()=>g.insecure!==null,$e=()=>{g.insecure=null},Te=async e=>(console.warn("Warning: generateProfileUrl is deprecated. Please use generatePortalUrl instead."),H({domain:e.domain,returnUrl:e.returnUrl,subNav:e.subNav}));function xe(e,t=[]){try{const r=new URL(e);return!t.includes(r.protocol)&&!!r.host}catch{return!1}}const H=async({domain:e,returnUrl:t,subNav:r})=>{const n=p();if(!n)throw new Error("generatePortalUrl: Active storage not found");const o=await n.getSessionItem(i.accessToken);if(!o)throw new Error("generatePortalUrl: Access Token not found");if(!xe(t,["ftp:","ws:"]))throw new Error("generatePortalUrl: returnUrl must be an absolute URL");const c=new URLSearchParams({sub_nav:r||L.profile,return_url:t}),a=await fetch(`${U(e)}/account_api/v1/portal_link?${c.toString()}`,{headers:{Authorization:`Bearer ${o}`}});if(!a.ok)throw new Error(`Failed to fetch profile URL: ${a.status} ${a.statusText}`);const f=await a.json();if(!f.url||typeof f.url!="string")throw new Error("Invalid URL received from API");try{return{url:new URL(f.url)}}catch(l){throw console.error(l),new Error(`Invalid URL format received from API: ${f.url}`)}},Ie={__esModule:!0,default:async()=>(await Promise.resolve().then(()=>require("./expoSecureStore-C5myBInt.cjs"))).ExpoSecureStore};exports.ChromeStore=oe;exports.ExpoSecureStore=Ie;exports.IssuerRouteTypes=C;exports.KvStorage=ae;exports.LocalStorage=se;exports.MemoryStorage=ne;exports.PortalPage=L;exports.ProfilePage=q;exports.PromptTypes=E;exports.RefreshType=S;exports.Scopes=j;exports.SessionBase=$;exports.StorageKeys=i;exports.base64UrlEncode=b;exports.checkAuth=te;exports.clearActiveStorage=_e;exports.clearInsecureStorage=$e;exports.clearRefreshTimer=R;exports.exchangeAuthCode=K;exports.extractAuthResults=Q;exports.frameworkSettings=w;exports.generateAuthUrl=Y;exports.generatePortalUrl=H;exports.generateProfileUrl=Te;exports.generateRandomString=P;exports.getActiveStorage=p;exports.getClaim=ce;exports.getClaims=D;exports.getCurrentOrganization=le;exports.getDecodedToken=m;exports.getFlag=fe;exports.getInsecureStorage=x;exports.getPermission=he;exports.getPermissions=ge;exports.getRawToken=ue;exports.getRoles=ke;exports.getUserOrganizations=me;exports.getUserProfile=de;exports.hasActiveStorage=pe;exports.hasInsecureStorage=ye;exports.isAuthenticated=Se;exports.isCustomDomain=v;exports.mapLoginMethodParamsForUrl=B;exports.refreshToken=T;exports.sanitizeUrl=U;exports.setActiveStorage=we;exports.setInsecureStorage=ve;exports.setRefreshTimer=N;exports.splitString=y;exports.storageSettings=s;
